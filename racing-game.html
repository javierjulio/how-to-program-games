<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Racing Game</title>
</head>
<body>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
var carImage = document.createElement("img");
var carImageLoaded = false;

var carX = 75;
var carY = 75;
var carAngle = 0;
var carSpeed = 0;

const GROUNDSPEED_DECAY_MULTIPLIER = 0.94;
const DRIVE_POWER = 0.5;
const REVERSE_POWER = 0.2;
const TURN_RATE = 0.07;

const TRACK_WIDTH = 40;
const TRACK_HEIGHT = 40;
const TRACK_GAP = 2;
const TRACK_COLS = 20;
const TRACK_ROWS = 15;
var trackGrid = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
                 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
                 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
                 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
                 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
                 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
                 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
                 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
                 1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
                 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
                 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
                 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                 ];

const TRACK_ROAD = 0;
const TRACK_WALL = 1;
const TRACK_PLAYER_START = 2;

var canvas, canvasContext;

const KEY_LEFT_ARROW = 37;
const KEY_UP_ARROW = 38;
const KEY_DOWN_ARROW = 40;
const KEY_RIGHT_ARROW = 39;

var keyHeld_Gas = false;
var keyHeld_Reverse = false;
var keyHeld_TurnLeft = false;
var keyHeld_TurnRight = false;

var mouseX = 0;
var mouseY = 0;

function keyDownHandler(event) {
  if (event.keyCode == KEY_LEFT_ARROW) {
    keyHeld_TurnLeft = true
  }
  if (event.keyCode == KEY_RIGHT_ARROW) {
    keyHeld_TurnRight = true
  }
  if (event.keyCode == KEY_UP_ARROW) {
    keyHeld_Gas = true
  }
  if (event.keyCode == KEY_DOWN_ARROW) {
    keyHeld_Reverse = true
  }
  event.preventDefault()
}

function keyUpHandler(event) {
  if (event.keyCode == KEY_LEFT_ARROW) {
    keyHeld_TurnLeft = false
  }
  if (event.keyCode == KEY_RIGHT_ARROW) {
    keyHeld_TurnRight = false
  }
  if (event.keyCode == KEY_UP_ARROW) {
    keyHeld_Gas = false
  }
  if (event.keyCode == KEY_DOWN_ARROW) {
    keyHeld_Reverse = false
  }
}

window.onload = function() {
  canvas = document.getElementById('gameCanvas');
  canvasContext = canvas.getContext('2d');

  var framesPerSecond = 30;
  setInterval(updateAll, 1000/framesPerSecond);

  canvas.addEventListener('mousemove', updateMousePosition);

  document.addEventListener('keydown', keyDownHandler);
  document.addEventListener('keyup', keyUpHandler);

  carImage.onload = function() {
    carImageLoaded = true;
  }
  carImage.src = "player1car.png";

  carReset();
}

function updateMousePosition(event) {
  var rect = canvas.getBoundingClientRect();
  var root = document.documentElement;
  mouseX = event.clientX - rect.left - root.scrollLeft;
  mouseY = event.clientY - rect.top - root.scrollTop;
  // carX = mouseX;
  // carY = mouseY;
}

function updateAll() {
  moveAll()
  drawAll()
}

function carReset() {
  for (var row = 0; row < TRACK_ROWS; row++) {
    for (var col = 0; col < TRACK_COLS; col++) {
      var arrayIndex = rowColToArrayIndex(col, row);
      if (trackGrid[arrayIndex] === TRACK_PLAYER_START) {
        trackGrid[arrayIndex] = TRACK_ROAD;
        carAngle = -Math.PI/2
        carX = col * TRACK_WIDTH + TRACK_WIDTH / 2;
        carY = row * TRACK_HEIGHT + TRACK_HEIGHT / 2;
      }
    }
  }
}

function carMove() {
  carSpeed *= GROUNDSPEED_DECAY_MULTIPLIER;

  if (keyHeld_Gas) {
    carSpeed += DRIVE_POWER;
  }
  if (keyHeld_Reverse) {
    carSpeed -= REVERSE_POWER;
  }
  if (keyHeld_TurnLeft) {
    carAngle -= TURN_RATE;
  }
  if (keyHeld_TurnRight) {
    carAngle += TURN_RATE;
  }

  carX += Math.cos(carAngle) * carSpeed;
  carY += Math.sin(carAngle) * carSpeed;
}

function isWallAtColRow(col, row) {
  if (col >= 0 && col < TRACK_COLS &&
      row >= 0 && row < TRACK_ROWS) {
    return (trackGrid[rowColToArrayIndex(col, row)] === TRACK_WALL);
  } else {
    return false
  }
}

function carTrackHandling() {
  var carTrackCol = Math.floor(carX / TRACK_WIDTH);
  var carTrackRow = Math.floor(carY / TRACK_HEIGHT);
  var trackIndexUnderCar = rowColToArrayIndex(carTrackCol, carTrackRow);

  if (carTrackCol >= 0 && carTrackCol < TRACK_COLS &&
      carTrackRow >= 0 && carTrackRow < TRACK_ROWS) {

    if (isWallAtColRow(carTrackCol, carTrackRow)) {
      carX -= Math.cos(carAngle) * carSpeed;
      carY -= Math.sin(carAngle) * carSpeed;

      carSpeed *= -0.5
    }
  }
}

function moveAll() {
  carMove();

  carTrackHandling();
}

function drawAll() {
  colorRect(0, 0, canvas.width, canvas.height, 'black');

  if (carImageLoaded) {
    drawBitmapCenteredWithRotation(carImage, carX, carY, carAngle);
  }

  drawTracks();
}

function rowColToArrayIndex(col, row) {
  return col + TRACK_COLS * row;
}

function drawTracks() {
  for (var row = 0; row < TRACK_ROWS; row++) {
    for (var col = 0; col < TRACK_COLS; col++) {
      var arrayIndex = rowColToArrayIndex(col, row);
      if (trackGrid[arrayIndex] === TRACK_WALL) {
        colorRect(TRACK_WIDTH*col, TRACK_HEIGHT * row, TRACK_WIDTH - TRACK_GAP, TRACK_HEIGHT - TRACK_GAP, 'blue');
      }
    }
  }
}

function drawBitmapCenteredWithRotation(bitmap, x, y, angle) {
  canvasContext.save()
  canvasContext.translate(x, y)
  canvasContext.rotate(angle)
  canvasContext.drawImage(bitmap, -bitmap.width / 2, -bitmap.height / 2)
  canvasContext.restore()
}

function colorRect(topLeftX, topLeftY, width, height, fillColor) {
  canvasContext.fillStyle = fillColor;
  canvasContext.fillRect(topLeftX, topLeftY, width, height);
}

function colorCircle(x, y, radius, fillColor) {
  canvasContext.fillStyle = fillColor;
  canvasContext.beginPath();
  canvasContext.arc(x, y, radius, 0, Math.PI*2, true);
  canvasContext.fill();
}

function colorText(text, x, y, fillColor) {
  canvasContext.fillStyle = fillColor;
  canvasContext.fillText(text, x, y);
}
</script>

</body>
</html>
